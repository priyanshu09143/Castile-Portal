<%- include('../partials/head') %>
<%- include('../partials/nav') %>
<main class="main">
  <header class="page-header">
    <h1>Products</h1>
    <div>
      <a href="/categories" class="btn">Categories</a>
      <a href="/products/new" class="btn btn-primary">Add Product</a>
    </div>
  </header>

  <% if (products.length) { %>
  <div class="product-grid">
    <% products.forEach(p => { %>
    <div class="product-card">
      <div class="product-img">
        <% if (p.image) { %><img src="<%= p.image %>" alt="<%= p.name %>"><% } else { %><span class="no-img">No image</span><% } %>
      </div>
      <div class="product-info">
        <h3><%= p.name %></h3>
        <% if (p.category) { %><p class="product-meta">Category: <%= p.category.name %><% if (p.subcategory) { %> → <%= p.subcategory.name %><% } %></p><% } %>
        <% if (p.variants && p.variants.length) { %>
          <p class="product-meta">Variants:</p>
          <ul class="variant-list">
            <% p.variants.forEach((v, i) => { %>
            <li>
              <strong><%= v.name %></strong> — Stock: <%= v.stock %>, <%= (v.price || p.price || 0).toLocaleString('en-IN', { style: 'currency', currency: 'INR' }) %>
              <form action="/products/<%= p._id %>/restock" method="post" class="form-inline">
                <input type="hidden" name="variantIndex" value="<%= i %>">
                <input type="number" name="quantity" min="1" placeholder="Qty" required>
                <button type="submit" class="btn btn-sm">Restock</button>
              </form>
            </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p>Stock: <strong><%= p.stock %></strong></p>
          <p>Price: <%= (p.price || 0).toLocaleString('en-IN', { style: 'currency', currency: 'INR' }) %></p>
          <div class="product-actions">
            <form action="/products/<%= p._id %>/restock" method="post" class="form-inline">
              <input type="number" name="quantity" min="1" required>
              <button type="submit" class="btn btn-sm">Restock</button>
            </form>
          </div>
        <% } %>
        <div class="product-actions" style="margin-top: 0.5rem;">
          <a href="/products/<%= p._id %>/edit" class="btn btn-sm">Edit</a>
          <form action="/products/<%= p._id %>?_method=DELETE" method="post" class="form-inline" onsubmit="return confirm('Delete this product?');">
            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
          </form>
        </div>
      </div>
    </div>
    <% }) %>
  </div>
  <% } else { %>
  <p class="muted">No products yet. <a href="/categories">Set up categories</a> then <a href="/products/new">Add your first product</a></p>
  <% } %>
</main>
<%- include('../partials/footer') %>
