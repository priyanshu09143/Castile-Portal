<%- include('../partials/head') %>
<%- include('../partials/nav') %>
<main class="main">
  <header class="page-header">
    <h1><%= product ? 'Edit Product' : 'Add Product' %></h1>
    <a href="/products" class="btn">Back to Products</a>
  </header>

  <form action="<%= product ? '/products/' + product._id + '?_method=PUT' : '/products' %>" method="post" enctype="multipart/form-data" class="form form-card" id="productForm">
    <label>Product name</label>
    <input type="text" name="name" value="<%= product ? product.name : '' %>" required>

    <label>Category</label>
    <select name="categoryId" id="categoryId">
      <option value="">None</option>
      <% (categories || []).forEach(c => { %>
      <option value="<%= c._id %>" <%= product && product.category && product.category._id.toString() === c._id.toString() ? 'selected' : '' %>><%= c.name %></option>
      <% }) %>
    </select>

    <label>Subcategory</label>
    <select name="subcategoryId" id="subcategoryId">
      <option value="">None</option>
      <% (subcategories || []).forEach(s => { %>
      <option value="<%= s._id %>" data-category="<%= s.category._id %>" <%= product && product.subcategory && product.subcategory._id.toString() === s._id.toString() ? 'selected' : '' %>><%= s.name %></option>
      <% }) %>
    </select>

    <div id="simpleFields">
      <label>Stock (when no variants)</label>
      <input type="number" name="stock" id="stock" min="0" value="<%= product && (!product.variants || !product.variants.length) ? product.stock : 0 %>">
      <label>Price (â‚¹)</label>
      <input type="number" name="price" id="price" min="0" step="0.01" value="<%= product ? product.price : '' %>">
    </div>

    <label>Image</label>
    <% if (product && product.image) { %>
    <p class="current-img">Current: <img src="<%= product.image %>" alt="" class="thumb"> Leave empty to keep.</p>
    <% } %>
    <input type="file" name="image" accept="image/*">

    <hr style="margin: 1.5rem 0; border-color: var(--border);">
    <h3 style="margin: 0 0 0.5rem;">Variants (optional)</h3>
    <p class="muted" style="font-size: 0.9rem; margin-bottom: 1rem;">If you add variants, product stock/price above are ignored; each variant has its own details.</p>
    <div id="variantRows">
      <% if (product && product.variants && product.variants.length) { %>
        <% product.variants.forEach((v, i) => { %>
        <div class="variant-row">
          <input type="text" name="variant_name[]" placeholder="Variant name (e.g. Red / L)" value="<%= v.name %>" required>
          <input type="text" name="variant_sku[]" placeholder="SKU" value="<%= v.sku %>">
          <input type="number" name="variant_price[]" min="0" step="0.01" placeholder="Price" value="<%= v.price %>">
          <input type="number" name="variant_stock[]" min="0" placeholder="Stock" value="<%= v.stock %>" required>
          <button type="button" class="btn btn-sm btn-danger variant-remove">Remove</button>
        </div>
        <% }) %>
      <% } %>
    </div>
    <button type="button" id="addVariant" class="btn btn-sm" style="margin-top: 0.5rem;">+ Add variant</button>

    <button type="submit" class="btn btn-primary" style="margin-top: 1.5rem;"><%= product ? 'Update' : 'Add' %> Product</button>
  </form>
</main>
<script>
(function() {
  var cat = document.getElementById('categoryId');
  var sub = document.getElementById('subcategoryId');
  if (cat && sub) {
    function filterSubs() {
      var cid = cat.value;
      for (var i = 0; i < sub.options.length; i++) {
        var opt = sub.options[i];
        if (opt.value === '') { opt.style.display = 'block'; continue; }
        opt.style.display = opt.getAttribute('data-category') === cid ? 'block' : 'none';
        if (opt.getAttribute('data-category') !== cid && opt.selected) opt.selected = false;
      }
    }
    cat.addEventListener('change', filterSubs);
    filterSubs();
  }
  var container = document.getElementById('variantRows');
  var addBtn = document.getElementById('addVariant');
  if (addBtn && container) {
    addBtn.addEventListener('click', function() {
      var row = document.createElement('div');
      row.className = 'variant-row';
      row.innerHTML = '<input type="text" name="variant_name[]" placeholder="Variant name (e.g. Red / L)" required>' +
        '<input type="text" name="variant_sku[]" placeholder="SKU">' +
        '<input type="number" name="variant_price[]" min="0" step="0.01" placeholder="Price">' +
        '<input type="number" name="variant_stock[]" min="0" placeholder="Stock" required>' +
        '<button type="button" class="btn btn-sm btn-danger variant-remove">Remove</button>';
      container.appendChild(row);
      row.querySelector('.variant-remove').addEventListener('click', function() { row.remove(); });
    });
    container.addEventListener('click', function(e) {
      if (e.target.classList.contains('variant-remove')) e.target.closest('.variant-row').remove();
    });
  }
})();
</script>
<%- include('../partials/footer') %>
